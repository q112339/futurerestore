name: Build futurerestore Windows
on: [workflow_dispatch]

permissions:
  contents: read

jobs:
  build-windows:
    name: Build Windows (MINGW64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout 源码
        uses: actions/checkout@v4

      - name: 配置MSYS2环境
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >
            git make autoconf automake libtool pkg-config gcc libzip openssl curl sed

      - name: 彻底删除所有依赖校验（核心！）
        run: |
          # 删掉libgeneral的版本校验
          sed -i '/PKG_CHECK_MODULES.*libgeneral/d' libpatchfinder/configure.ac
          # 删掉所有其他依赖校验
          sed -i '/PKG_CHECK_MODULES/d' libpatchfinder/configure.ac
          # 强制给libpatchfinder添加libgeneral的头文件和库路径
          echo -e "\nCFLAGS+=-I/mingw64/include\nLIBS+=-L/mingw64/lib -lgeneral" >> libpatchfinder/configure.ac

      - name: 编译安装libgeneral
        run: |
          cd libgeneral
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4 && make install
          cd ..

      - name: 强制编译libpatchfinder
        run: |
          cd libpatchfinder
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4 && make install
          cd ..

      - name: 编译安装libipatcher
        run: |
          cd libipatcher
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4 && make install
          cd ..

      - name: 编译futurerestore
        run: |
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4
          strip src/futurerestore.exe

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-windows
          path: src/futurerestore.exe
