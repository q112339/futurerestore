name: Build futurerestore v193
on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-windows:
    name: Build for Windows (MINGW64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout 主源码（含全量依赖）
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 配置 MSYS2 全量编译环境（先配置环境，再执行修改）
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            git make autoconf automake libtool pkg-config binutils sed
            mingw-w64-x86_64-gcc mingw-w64-x86_64-libzip
            mingw-w64-x86_64-openssl mingw-w64-x86_64-curl
            mingw-w64-x86_64-libpng mingw-w64-x86_64-bzip2

      - name: 【核心修复】自动修复版本号+禁用依赖校验
        run: |
          # 修复libgeneral版本号为71，满足>=65的要求
          sed -i 's/AC_INIT(\[libgeneral\], \[.*\]/AC_INIT([libgeneral], [71]/' libgeneral/configure.ac
          # 去掉libgeneral的版本校验要求
          sed -i 's/PKG_CHECK_MODULES(\[libgeneral\], \[libgeneral >= 65\])/PKG_CHECK_MODULES([libgeneral], [libgeneral])/' libpatchfinder/configure.ac
          # 彻底删除所有可选依赖的强制校验
          sed -i '/PKG_CHECK_MODULES(\[libinsn\]/d' libpatchfinder/configure.ac
          sed -i '/PKG_CHECK_MODULES(\[libimg4tool\]/d' libpatchfinder/configure.ac
          sed -i '/PKG_CHECK_MODULES(\[libm3tools\]/d' libpatchfinder/configure.ac

      - name: 全局环境变量配置
        run: |
          export PREFIX=/mingw64
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig:$PREFIX/share/pkgconfig
          export CFLAGS="-I$PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib"
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV

      - name: 编译安装 libgeneral
        run: |
          cd libgeneral
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..
          pkg-config --modversion libgeneral

      - name: 编译安装 libpatchfinder
        run: |
          cd libpatchfinder
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

      - name: 编译安装 libipatcher
        run: |
          cd libipatcher
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          make install
          cd ..

      - name: 编译 futurerestore 主程序
        run: |
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          strip src/futurerestore.exe

      - name: 上传 Windows 编译产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-v193-windows-x64
          path: src/futurerestore.exe
          retention-days: 90

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    steps:
      - name: Checkout 主源码（含全量依赖）
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 安装 Homebrew 全量依赖（先配置环境）
        run: |
          brew install git autoconf automake libtool pkg-config libzip openssl@1.1 binutils gnu-sed

      - name: 【核心修复】自动修复版本号+禁用依赖校验
        run: |
          # 用gnu-sed确保跨平台兼容，修复版本号
          gsed -i 's/AC_INIT(\[libgeneral\], \[.*\]/AC_INIT([libgeneral], [71]/' libgeneral/configure.ac
          # 去掉libgeneral的版本校验要求
          gsed -i 's/PKG_CHECK_MODULES(\[libgeneral\], \[libgeneral >= 65\])/PKG_CHECK_MODULES([libgeneral], [libgeneral])/' libpatchfinder/configure.ac
          # 彻底删除所有可选依赖的强制校验
          gsed -i '/PKG_CHECK_MODULES(\[libinsn\]/d' libpatchfinder/configure.ac
          gsed -i '/PKG_CHECK_MODULES(\[libimg4tool\]/d' libpatchfinder/configure.ac
          gsed -i '/PKG_CHECK_MODULES(\[libm3tools\]/d' libpatchfinder/configure.ac

      - name: 全局环境变量配置（兼容全芯片）
        run: |
          if [ -d "/opt/homebrew" ]; then
            export BREW_PREFIX=/opt/homebrew
          else
            export BREW_PREFIX=/usr/local
          fi
          export PREFIX=/usr/local
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig:$PREFIX/share/pkgconfig:$BREW_PREFIX/lib/pkgconfig:$BREW_PREFIX/opt/openssl@1.1/lib/pkgconfig
          export CFLAGS="-I$PREFIX/include -I$BREW_PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib -L$BREW_PREFIX/lib"
          echo "BREW_PREFIX=$BREW_PREFIX" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV

      - name: 编译安装 libgeneral
        run: |
          cd libgeneral
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(sysctl -n hw.ncpu)
          sudo make install
          cd ..
          pkg-config --modversion libgeneral

      - name: 编译安装 libpatchfinder
        run: |
          cd libpatchfinder
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(sysctl -n hw.ncpu)
          sudo make install
          cd ..

      - name: 编译安装 libipatcher
        run: |
          cd libipatcher
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(sysctl -n hw.ncpu)
          sudo make install
          cd ..

      - name: 编译 futurerestore 主程序
        run: |
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(sysctl -n hw.ncpu)
          strip src/futurerestore

      - name: 上传 macOS 编译产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-v193-macos
          path: src/futurerestore
          retention-days: 90

  build-linux:
    name: Build for Linux (x64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 主源码（含全量依赖）
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 安装系统全量依赖（先配置环境）
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential autoconf automake libtool pkg-config libcurl4-openssl-dev libzip-dev libssl-dev libpng-dev libbz2-dev binutils-dev libiberty-dev sed

      - name: 【核心修复】自动修复版本号+禁用依赖校验
        run: |
          # 修复libgeneral版本号为71
          sed -i 's/AC_INIT(\[libgeneral\], \[.*\]/AC_INIT([libgeneral], [71]/' libgeneral/configure.ac
          # 去掉libgeneral的版本校验要求
          sed -i 's/PKG_CHECK_MODULES(\[libgeneral\], \[libgeneral >= 65\])/PKG_CHECK_MODULES([libgeneral], [libgeneral])/' libpatchfinder/configure.ac
          # 彻底删除所有可选依赖的强制校验
          sed -i '/PKG_CHECK_MODULES(\[libinsn\]/d' libpatchfinder/configure.ac
          sed -i '/PKG_CHECK_MODULES(\[libimg4tool\]/d' libpatchfinder/configure.ac
          sed -i '/PKG_CHECK_MODULES(\[libm3tools\]/d' libpatchfinder/configure.ac

      - name: 全局环境变量配置
        run: |
          export PREFIX=/usr/local
          export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig:$PREFIX/share/pkgconfig
          export CFLAGS="-I$PREFIX/include"
          export LDFLAGS="-L$PREFIX/lib"
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
          echo "alias sudo='sudo -E'" >> ~/.bashrc
          source ~/.bashrc

      - name: 编译安装 libgeneral
        run: |
          cd libgeneral
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          sudo -E make install
          sudo ldconfig
          cd ..
          pkg-config --modversion libgeneral

      - name: 编译安装 libpatchfinder
        run: |
          cd libpatchfinder
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          sudo -E make install
          sudo ldconfig
          cd ..

      - name: 编译安装 libipatcher
        run: |
          cd libipatcher
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          sudo -E make install
          sudo ldconfig
          cd ..

      - name: 编译 futurerestore 主程序
        run: |
          chmod +x autogen.sh
          autoreconf -i --force
          ./autogen.sh --prefix=$PREFIX --disable-static --enable-shared
          make -j$(nproc)
          strip src/futurerestore

      - name: 上传 Linux 编译产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-v193-linux-x64
          path: src/futurerestore
          retention-days: 90
