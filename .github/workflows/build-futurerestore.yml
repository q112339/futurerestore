name: Build futurerestore Windows Only
on: [workflow_dispatch]

permissions:
  contents: read

jobs:
  build-windows:
    name: Build Windows (MINGW64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout 源码
        uses: actions/checkout@v4

      - name: 配置MSYS2环境
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >
            git make autoconf automake libtool pkg-config gcc libzip openssl curl

      - name: 【核弹级修复】直接重写libpatchfinder的configure.ac
        run: |
          # 直接用一个最小化的、没有任何依赖检查的configure.ac覆盖原文件
          cat > libpatchfinder/configure.ac << 'EOF'
AC_INIT([libpatchfinder], [198])
AM_INIT_AUTOMAKE([-Wall -Werror foreign])
AC_PROG_CC
AC_PROG_CXX
AC_PROG_INSTALL
AC_PROG_LIBTOOL
# 手动指定libgeneral的路径，跳过所有检查
CFLAGS="-I/mingw64/include"
LIBS="-L/mingw64/lib -lgeneral"
AC_OUTPUT([Makefile libpatchfinder.pc])
EOF

      - name: 编译安装libgeneral
        run: |
          cd libgeneral
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4 && make install
          cd ..

      - name: 编译libpatchfinder
        run: |
          cd libpatchfinder
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4 && make install
          cd ..

      - name: 编译安装libipatcher
        run: |
          cd libipatcher
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4 && make install
          cd ..

      - name: 编译futurerestore
        run: |
          autoreconf -i
          ./configure --prefix=/mingw64 --disable-static
          make -j4
          strip src/futurerestore.exe

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-windows
          path: src/futurerestore.exe
