name: Build futurerestore v193
on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-windows:
    name: Build for Windows (MINGW64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout 主源码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 配置 MSYS2 环境
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            make autoconf automake libtool pkg-config wget tar gzip file
            mingw-w64-x86_64-gcc mingw-w64-x86_64-libzip
            mingw-w64-x86_64-openssl mingw-w64-x86_64-curl
            mingw-w64-x86_64-libpng mingw-w64-x86_64-bzip2

      - name: 编译安装 libgeneral v71（CDN加速，无网络限制）
        run: |
          # 全球CDN链接，彻底绕开GitHub访问限制
          wget --tries=5 --waitretry=3 --timeout=10 \
          https://cdn.jsdelivr.net/gh/tihmstar/libgeneral@57c5c8e.tar.gz \
          -O libgeneral.tar.gz
          
          # 校验压缩包有效性
          file libgeneral.tar.gz | grep -q "gzip compressed data"
          
          # 解压编译
          tar -zxf libgeneral.tar.gz
          cd libgeneral-57c5c8e
          ./autogen.sh --prefix=/mingw64 --disable-static
          make -j$(nproc)
          make install
          cd ..

      - name: 编译安装 libipatcher v43（CDN加速，无网络限制）
        run: |
          wget --tries=5 --waitretry=3 --timeout=10 \
          https://cdn.jsdelivr.net/gh/tihmstar/libipatcher@3e78c7d.tar.gz \
          -O libipatcher.tar.gz
          
          file libipatcher.tar.gz | grep -q "gzip compressed data"
          
          tar -zxf libipatcher.tar.gz
          cd libipatcher-3e78c7d
          ./autogen.sh --prefix=/mingw64 --disable-static
          make -j$(nproc)
          make install
          cd ..

      - name: 编译 futurerestore 主程序
        run: |
          ./autogen.sh --prefix=/mingw64 --disable-static
          make -j$(nproc)
          strip src/futurerestore.exe

      - name: 上传 Windows 编译产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-v193-windows-x64
          path: src/futurerestore.exe
          retention-days: 90

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    steps:
      - name: Checkout 主源码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 安装 Homebrew 依赖
        run: |
          brew install autoconf automake libtool pkg-config libzip openssl@1.1 wget
          echo 'export PKG_CONFIG_PATH="/usr/local/opt/openssl@1.1/lib/pkgconfig:$PKG_CONFIG_PATH"' >> ~/.zshrc
          source ~/.zshrc

      - name: 编译安装 libgeneral v71
        run: |
          wget --tries=5 --waitretry=3 --timeout=10 \
          https://cdn.jsdelivr.net/gh/tihmstar/libgeneral@57c5c8e.tar.gz \
          -O libgeneral.tar.gz
          
          file libgeneral.tar.gz | grep -q "gzip compressed data"
          
          tar -zxf libgeneral.tar.gz
          cd libgeneral-57c5c8e
          ./autogen.sh --disable-static
          make -j$(sysctl -n hw.ncpu)
          sudo make install
          cd ..

      - name: 编译安装 libipatcher v43
        run: |
          wget --tries=5 --waitretry=3 --timeout=10 \
          https://cdn.jsdelivr.net/gh/tihmstar/libipatcher@3e78c7d.tar.gz \
          -O libipatcher.tar.gz
          
          file libipatcher.tar.gz | grep -q "gzip compressed data"
          
          tar -zxf libipatcher.tar.gz
          cd libipatcher-3e78c7d
          ./autogen.sh --disable-static
          make -j$(sysctl -n hw.ncpu)
          sudo make install
          cd ..

      - name: 编译 futurerestore 主程序
        run: |
          ./autogen.sh --disable-static
          make -j$(sysctl -n hw.ncpu)
          strip src/futurerestore

      - name: 上传 macOS 编译产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-v193-macos
          path: src/futurerestore
          retention-days: 90

  build-linux:
    name: Build for Linux (x64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 主源码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config libcurl4-openssl-dev libzip-dev libssl-dev libpng-dev libbz2-dev wget

      - name: 编译安装 libgeneral v71
        run: |
          wget --tries=5 --waitretry=3 --timeout=10 \
          https://cdn.jsdelivr.net/gh/tihmstar/libgeneral@57c5c8e.tar.gz \
          -O libgeneral.tar.gz
          
          file libgeneral.tar.gz | grep -q "gzip compressed data"
          
          tar -zxf libgeneral.tar.gz
          cd libgeneral-57c5c8e
          ./autogen.sh --disable-static
          make -j$(nproc)
          sudo make install
          sudo ldconfig
          cd ..

      - name: 编译安装 libipatcher v43
        run: |
          wget --tries=5 --waitretry=3 --timeout=10 \
          https://cdn.jsdelivr.net/gh/tihmstar/libipatcher@3e78c7d.tar.gz \
          -O libipatcher.tar.gz
          
          file libipatcher.tar.gz | grep -q "gzip compressed data"
          
          tar -zxf libipatcher.tar.gz
          cd libipatcher-3e78c7d
          ./autogen.sh --disable-static
          make -j$(nproc)
          sudo make install
          sudo ldconfig
          cd ..

      - name: 编译 futurerestore 主程序
        run: |
          ./autogen.sh --disable-static
          make -j$(nproc)
          strip src/futurerestore

      - name: 上传 Linux 编译产物
        uses: actions/upload-artifact@v4
        with:
          name: futurerestore-v193-linux-x64
          path: src/futurerestore
          retention-days: 90
